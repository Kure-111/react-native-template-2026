# プロジェクト仕様書

最終更新日: YYYY/MM/DD

---

## 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [対象ユーザー](#対象ユーザー)
3. [機能要件](#機能要件)
4. [画面設計](#画面設計)
5. [データベース設計](#データベース設計)
6. [API 設計](#api設計)
7. [非機能要件](#非機能要件)
8. [使用技術](#使用技術)
9. [セキュリティ設計](#セキュリティ設計)

---

## プロジェクト概要

### 目的

（このシステムを作る目的・背景）

### スケジュール

- 開発開始：YYYY/MM/DD
- リリース予定：YYYY/MM/DD

---

## 対象ユーザー

### ○○ 部

- **いつ使うか：** （例：大学祭当日、準備期間中など）
- **どういうときに使うか：** （例：イベント情報を確認したいとき、チケットを購入するときなど）

### △△ 部

- **いつ使うか：**
- **どういうときに使うか：**

---

## 機能要件

### 1. ○○ 機能

**概要：**
（この機能で何ができるか）

**詳細仕様：**

- 〜の場合、〜となる
- 〜ボタンを押すと〜する

---

### 2. △△ 機能

（同様に記載）

---

## 画面設計

### 1. ○○ 画面

**画面名:** ScreenName  
**パス/識別子:** `/path`

**表示項目:**

- 項目 1（UI 要素の種類）
- 項目 2（UI 要素の種類）

**動作:**

1. ユーザーが〜を入力
2. 〜ボタンをタップ
3. 〜を実行
4. 成功 → 〜画面へ遷移
5. 失敗 → エラーメッセージを表示

---

### 2. △△ 画面

（同様に記載）

---

## データベース設計

### テーブル一覧

| テーブル名 | 説明         |
| ---------- | ------------ |
| users      | ユーザー情報 |
| events     | イベント情報 |

---

### users テーブル

**説明:** ユーザーアカウント情報を管理

| カラム名   | 型          | 制約             | 説明           |
| ---------- | ----------- | ---------------- | -------------- |
| id         | uuid        | PK               | ユーザー ID    |
| email      | text        | NOT NULL, UNIQUE | メールアドレス |
| name       | text        | NOT NULL         | ユーザー名     |
| created_at | timestamptz | NOT NULL         | 作成日時       |
| updated_at | timestamptz | NOT NULL         | 更新日時       |

**リレーション:**

- （他のテーブルとの関係）

---

### events テーブル

**説明:** イベント情報を管理

| カラム名   | 型          | 制約     | 説明             |
| ---------- | ----------- | -------- | ---------------- |
| id         | integer     | PK       | イベント ID      |
| title      | text        | NOT NULL | イベントタイトル |
| event_date | date        | NOT NULL | 開催日           |
| location   | text        |          | 開催場所         |
| created_at | timestamptz | NOT NULL | 作成日時         |
| updated_at | timestamptz | NOT NULL | 更新日時         |

**リレーション:**

- （他のテーブルとの関係）

---

## API 設計

### 1. Supabase REST API

**アクセス方法:**

ERP や外部システムが Supabase に直接アクセスする場合

**ベース URL:**

```
https://{PROJECT_ID}.supabase.co/rest/v1
```

**認証方法:**

以下の HTTP ヘッダーを付ける

```
apikey: {SUPABASE_ANON_KEY}
Authorization: Bearer {SUPABASE_ANON_KEY}
Content-Type: application/json
```

**必要な情報:**

- `PROJECT_ID`: Supabase プロジェクト設定から取得
- `SUPABASE_ANON_KEY`: Supabase プロジェクト設定 > API > Project API keys から取得

---

#### イベント一覧取得

```
GET /events?select=*
```

**リクエスト例:**

```bash
curl -X GET 'https://abcdefg.supabase.co/rest/v1/events?select=*' \
  -H "apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**レスポンス:**

```json
[
  {
    "id": 1,
    "title": "模擬店",
    "event_date": "2024-11-01",
    "location": "A棟",
    "created_at": "2024-01-01T00:00:00Z"
  }
]
```

---

#### 特定イベント取得

```
GET /events?id=eq.{EVENT_ID}&select=*
```

**リクエスト例:**

```bash
curl -X GET 'https://abcdefg.supabase.co/rest/v1/events?id=eq.1&select=*' \
  -H "apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**レスポンス:**

```json
[
  {
    "id": 1,
    "title": "模擬店",
    "event_date": "2024-11-01",
    "location": "A棟"
  }
]
```

---

#### イベント作成

```
POST /events
```

**リクエスト例:**

```bash
curl -X POST 'https://abcdefg.supabase.co/rest/v1/events' \
  -H "apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{
    "title": "新しいイベント",
    "event_date": "2024-11-01",
    "location": "B棟"
  }'
```

**レスポンス:**

```json
{
  "id": 2,
  "title": "新しいイベント",
  "event_date": "2024-11-01",
  "location": "B棟",
  "created_at": "2024-01-01T00:00:00Z"
}
```

---

### 2. GAS API

**アクセス方法:**

GAS（Google Apps Script）がデータを加工して ERP や外部システムに提供する場合

**ベース URL:**

```
https://script.google.com/macros/s/{DEPLOY_ID}/exec
```

**認証方法:**

クエリパラメータ`key`に API キーを指定

```
?key={API_KEY}
```

**必要な情報:**

- `DEPLOY_ID`: GAS をデプロイした後に発行される ID
- `API_KEY`: GAS のスクリプトプロパティで設定した API キー

**GAS のデプロイ方法:**

1. Google Apps Script エディタで「デプロイ」→「新しいデプロイ」
2. 種類：「ウェブアプリ」
3. アクセス権限：「全員」
4. デプロイ後に表示される「ウェブアプリの URL」が`DEPLOY_ID`を含む URL

---

#### 鍵の貸し出し状況取得

**説明:**
Google スプレッドシートから鍵の貸し出し状況を取得

```
GET /exec?key={API_KEY}&action=getKeys&date={YYYY-MM-DD}
```

**パラメータ:**
| 名前 | 型 | 必須 | 説明 |
|-----|-----|-----|------|
| key | string | Yes | API キー |
| action | string | Yes | `getKeys`固定 |
| date | string | Yes | 取得する日付（YYYY-MM-DD 形式） |

**リクエスト例:**

```bash
curl 'https://script.google.com/macros/s/ABC123.../exec?key=your-api-key&action=getKeys&date=2024-11-01'
```

**レスポンス（成功時）:**

```json
{
  "data": [
    {
      "date": "2024-11-01",
      "key_id": "K001",
      "room_number": "A101",
      "borrower": "山田太郎",
      "status": "貸出中"
    }
  ]
}
```

**レスポンス（エラー時）:**

```json
{
  "error": "Invalid API key"
}
```

---

#### イベント集計データ取得

**説明:**
Supabase と Google スプレッドシートのデータを集計して提供

```
GET /exec?key={API_KEY}&action=getEventSummary&date={YYYY-MM-DD}
```

**パラメータ:**
| 名前 | 型 | 必須 | 説明 |
|-----|-----|-----|------|
| key | string | Yes | API キー |
| action | string | Yes | `getEventSummary`固定 |
| date | string | Yes | 集計する日付（YYYY-MM-DD 形式） |

**リクエスト例:**

```bash
curl 'https://script.google.com/macros/s/ABC123.../exec?key=your-api-key&action=getEventSummary&date=2024-11-01'
```

**レスポンス（成功時）:**

```json
{
  "data": {
    "date": "2024-11-01",
    "total_events": 15,
    "total_participants": 1200,
    "events": [
      {
        "title": "模擬店",
        "participants": 500
      }
    ]
  }
}
```

---

## 非機能要件

### パフォーマンス

- 画面遷移は 3 秒以内
- API 応答時間は 1 秒以内

### 可用性

- イベント期間中は稼働率 99%以上

### スケーラビリティ

- 同時アクセス数：○○ 人程度を想定

### 対応環境

- **iOS:** 15.0 以上
- **Android:** Android 10 以上

---

## 使用技術

### フロントエンド

- **React Native (Expo SDK XX)**
  - 理由：iOS/Android アプリを一つのコードで開発

### バックエンド

- **Supabase**
  - PostgreSQL データベース
  - 認証機能
  - ストレージ

### その他

- **GAS (Google Apps Script)**
  - 用途：外部システム（ERP）との連携、Google スプレッドシートとの連携

### 開発ツール

- Git/GitHub
- Visual Studio Code
- Expo Go

---

## セキュリティ設計

### 認証・認可

- **認証方式:** Supabase Auth（JWT）
- **セッション管理:** トークンベース

### データ保護

- **通信:** HTTPS 通信のみ
- **API キー管理:** 環境変数で管理（`.env`）
- **Supabase RLS:** Row Level Security (RLS)を設定し、ユーザーは自分のデータのみ閲覧・更新可能

---

## 更新履歴

| 日付       | バージョン | 更新内容 | 更新者 |
| ---------- | ---------- | -------- | ------ |
| 2024/01/01 | 1.0        | 初版作成 | 名前   |

---
