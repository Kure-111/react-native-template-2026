# é€šçŸ¥æ©Ÿèƒ½ã®ä½¿ã„æ–¹

## æ¦‚è¦

ERPã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§å…±æœ‰ã™ã‚‹é€šçŸ¥æ©Ÿèƒ½ã§ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã©ã“ã‹ã‚‰ã§ã‚‚ã€ç°¡å˜ãªé–¢æ•°å‘¼ã³å‡ºã—ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã‚’é€ä¿¡ã§ãã¾ã™ã€‚

## åŸºæœ¬çš„ãªä½¿ã„æ–¹

### 1. é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹

```javascript
// é€šçŸ¥ã‚’ä½¿ã„ãŸã„ç”»é¢/ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { sendNotification } from '@shared/services/sendNotification';

// ã‚·ãƒ³ãƒ—ãƒ«ãªä½¿ã„æ–¹ï¼šå˜ä¸€ãƒ­ãƒ¼ãƒ«ã«é€šçŸ¥
await sendNotification({
  type: 'info',
  message: 'ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ',
  recipientRoles: 'staff'
});

// è¤‡æ•°ãƒ­ãƒ¼ãƒ«ã«é€šçŸ¥
await sendNotification({
  type: 'warning',
  message: 'ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®äºˆå®šãŒã‚ã‚Šã¾ã™',
  recipientRoles: ['admin', 'operator', 'staff']
});

// ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ä»˜ã
await sendNotification({
  type: 'warning',
  message: 'å±‹å°ç•ªå·105éº»è–¬åµãŒå‡ºåº—åœæ­¢ã—ã¾ã—ãŸ',
  recipientRoles: 'vendor_manager',
  title: 'å±‹å°åœæ­¢ã®ãŠçŸ¥ã‚‰ã›',
  deepLink: '/item5/vendor/105'
});
```

### 2. é€šçŸ¥ã‚¿ã‚¤ãƒ—

åˆ©ç”¨å¯èƒ½ãªé€šçŸ¥ã‚¿ã‚¤ãƒ—ï¼š

| ã‚¿ã‚¤ãƒ— | èª¬æ˜ | å„ªå…ˆåº¦ | è‡ªå‹•é–‰ã˜ã‚‹ | è‰² |
|--------|------|--------|-----------|-----|
| `info` | ä¸€èˆ¬çš„ãªæƒ…å ±é€šçŸ¥ | ä½ | 7ç§’ | é’ |
| `success` | å‡¦ç†æˆåŠŸæ™‚ã®é€šçŸ¥ | ä½ | 5ç§’ | ç·‘ |
| `warning` | æ³¨æ„ãŒå¿…è¦ãªå†…å®¹ | ä¸­ | ãªã— | æ©™ |
| `error` | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®é€šçŸ¥ | é«˜ | ãªã— | èµ¤ |
| `vendor_stop` | å±‹å°åœæ­¢é€šçŸ¥ | é«˜ | ãªã— | èµ¤ |
| `schedule_change` | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ›´ | ä¸­ | 10ç§’ | ç´« |
| `inventory_alert` | åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ | ä¸­ | ãªã— | æ©™ |
| `user_action` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | ä½ | 5ç§’ | é’ç´« |

### 3. å—ä¿¡è€…ãƒ­ãƒ¼ãƒ«

åˆ©ç”¨å¯èƒ½ãªãƒ­ãƒ¼ãƒ«ï¼š

```javascript
// åŸºæœ¬ãƒ­ãƒ¼ãƒ«
'admin'              // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…
'operator'           // ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼
'staff'              // ã‚¹ã‚¿ãƒƒãƒ•

// éƒ¨é–€åˆ¥ãƒ­ãƒ¼ãƒ«
'vendor_manager'     // å±‹å°æ‹…å½“ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
'inventory_manager'  // åœ¨åº«ç®¡ç†è€…
'accountant'         // ä¼šè¨ˆæ‹…å½“è€…
'schedule_manager'   // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†è€…

// ã‚µãƒ¼ã‚¯ãƒ«é–¢é€£
'circle_leader'      // ã‚µãƒ¼ã‚¯ãƒ«è²¬ä»»è€…
'circle_member'      // ã‚µãƒ¼ã‚¯ãƒ«ãƒ¡ãƒ³ãƒãƒ¼

// ãã®ä»–
'manager'            // ç·åˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
```

## å®Ÿè£…ä¾‹

### å±‹å°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰é€šçŸ¥

```javascript
// src/features/item5/components/VendorManagement.jsx
import { sendNotification } from '@shared/services/sendNotification';

const handleVendorStop = async (vendorId, vendorName) => {
  // å±‹å°ã‚’åœæ­¢ã™ã‚‹å‡¦ç†...
  
  // é€šçŸ¥ã‚’é€ä¿¡
  await sendNotification({
    type: 'vendor_stop',
    message: `å±‹å°ç•ªå·${vendorId}ã€Œ${vendorName}ã€ãŒå‡ºåº—åœæ­¢ã—ã¾ã—ãŸ`,
    recipientRoles: ['vendor_manager', 'admin'],
    deepLink: `/item5/vendor/${vendorId}`
  });
};
```

### åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰é€šçŸ¥

```javascript
// src/features/item3/components/InventoryAlert.jsx
import { sendNotification } from '@shared/services/sendNotification';

const checkInventoryLevels = async (item) => {
  if (item.quantity < item.threshold) {
    await sendNotification({
      type: 'inventory_alert',
      message: `${item.name}ã®åœ¨åº«ãŒæ®‹ã‚Š${item.quantity}å€‹ã§ã™ã€‚è£œå……ãŒå¿…è¦ã§ã™ã€‚`,
      recipientRoles: 'inventory_manager',
      deepLink: `/item3/inventory/${item.id}`
    });
  }
};
```

### ä¼šè¨ˆã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰é€šçŸ¥

```javascript
// src/features/item8/components/DailyReport.jsx
import { sendNotification } from '@shared/services/sendNotification';

const submitDailyReport = async (date) => {
  // æ—¥å ±ã‚’æå‡ºã™ã‚‹å‡¦ç†...
  
  // æˆåŠŸé€šçŸ¥
  await sendNotification({
    type: 'success',
    message: `${date}ã®æ—¥å ±æå‡ºãŒå®Œäº†ã—ã¾ã—ãŸ`,
    recipientRoles: 'accountant',
    deepLink: `/item8/daily-report/${date}`
  });
};
```

## ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### æ–°ã—ã„é€šçŸ¥ã‚¿ã‚¤ãƒ—ã®è¿½åŠ 

1. `src/features/notifications/constants/notificationType.js` ã«ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ 

```javascript
export const NOTIFICATION_TYPES = {
  // æ—¢å­˜ã®ã‚¿ã‚¤ãƒ—...
  MY_NEW_TYPE: 'my_new_type'  // æ–°ã—ã„ã‚¿ã‚¤ãƒ—
};

export const NOTIFICATION_TYPE_CONFIG = {
  // æ—¢å­˜ã®è¨­å®š...
  [NOTIFICATION_TYPES.MY_NEW_TYPE]: {
    displayName: 'æ–°ã—ã„ã‚¿ã‚¤ãƒ—',
    color: '#FF6B6B',
    priority: 2,
    autoDismissSeconds: 8,
    icon: 'ğŸ””'
  }
};
```

2. ã™ãã«ä½¿ç”¨å¯èƒ½

```javascript
await sendNotification({
  type: 'my_new_type',
  message: 'æ–°ã—ã„ã‚¿ã‚¤ãƒ—ã®é€šçŸ¥ã§ã™',
  recipientRoles: 'staff'
});
```

### æ–°ã—ã„ãƒ­ãƒ¼ãƒ«ã®è¿½åŠ 

1. `src/shared/constants/userRoles.js` ã«ãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 

```javascript
export const USER_ROLES = {
  // æ—¢å­˜ã®ãƒ­ãƒ¼ãƒ«...
  MY_NEW_ROLE: 'my_new_role'  // æ–°ã—ã„ãƒ­ãƒ¼ãƒ«
};
```

2. Supabaseã®usersãƒ†ãƒ¼ãƒ–ãƒ«ã§è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®rolesã‚«ãƒ©ãƒ ã«è¿½åŠ 

3. ä½¿ç”¨å¯èƒ½

```javascript
await sendNotification({
  type: 'info',
  message: 'æ–°ã—ã„ãƒ­ãƒ¼ãƒ«å‘ã‘ã®é€šçŸ¥',
  recipientRoles: 'my_new_role'
});
```

## ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯

é€šçŸ¥ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã«ç‰¹å®šã®ç”»é¢ã«é·ç§»ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### å½¢å¼

```
/itemç•ªå·/è©³ç´°ãƒ‘ã‚¹
```

### ä¾‹

```javascript
// é …ç›®5ã®å±‹å°è©³ç´°ç”»é¢ã«é·ç§»
deepLink: '/item5/vendor/105'

// é …ç›®3ã®åœ¨åº«è©³ç´°ç”»é¢ã«é·ç§»
deepLink: '/item3/inventory/123'

// é …ç›®8ã®æ—¥å ±ç”»é¢ã«é·ç§»
deepLink: '/item8/daily-report/2026-01-15'
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œãªã„

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ç¢ºèª
- é€ä¿¡æ¨©é™ãŒã‚ã‚‹ãƒ­ãƒ¼ãƒ«ã‹ç¢ºèªï¼ˆç®¡ç†è€…ã€ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã€ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰
- recipientRolesãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### é€šçŸ¥ãŒå—ä¿¡ã•ã‚Œãªã„

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆSupabaseã®usersãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- ãƒ–ãƒ©ã‚¦ã‚¶ã®é€šçŸ¥æ¨©é™ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¥ç¶šãŒæœ‰åŠ¹ã‹ç¢ºèª

### æœªèª­ãƒãƒƒã‚¸ãŒè¡¨ç¤ºã•ã‚Œãªã„

- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒæ­£ã—ãå–å¾—ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- Supabaseã®notificationsãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

### å¿…è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«

é€šçŸ¥æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Supabaseã«ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå¿…è¦ã§ã™ï¼š

#### notifications ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type TEXT NOT NULL,
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  recipient_roles JSONB NOT NULL,
  target_user_ids JSONB NOT NULL,
  sent_by UUID NOT NULL,
  deep_link TEXT,
  metadata JSONB,
  status TEXT NOT NULL DEFAULT 'pending',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL
);
```

#### notification_reads ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE notification_reads (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  notification_id UUID NOT NULL REFERENCES notifications(id) ON DELETE CASCADE,
  user_id UUID NOT NULL,
  read_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(notification_id, user_id)
);
```

#### users ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ§‹é€ 

```sql
-- rolesã‚«ãƒ©ãƒ ãŒå¿…è¦
ALTER TABLE users ADD COLUMN IF NOT EXISTS roles JSONB DEFAULT '[]';
```

## API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

### sendNotification(params)

é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**

| åå‰ | å‹ | å¿…é ˆ | èª¬æ˜ |
|------|---|------|------|
| type | string | â—¯ | é€šçŸ¥ã‚¿ã‚¤ãƒ—ï¼ˆinfo, success, warning, errorç­‰ï¼‰ |
| message | string | â—¯ | é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ |
| recipientRoles | string \| string[] | â—¯ | å—ä¿¡è€…ã®ãƒ­ãƒ¼ãƒ«ï¼ˆå˜ä¸€ã¾ãŸã¯é…åˆ—ï¼‰ |
| title | string | âœ• | é€šçŸ¥ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆçœç•¥æ™‚ã¯è‡ªå‹•ç”Ÿæˆï¼‰ |
| deepLink | string | âœ• | ã‚¯ãƒªãƒƒã‚¯æ™‚ã®é·ç§»å…ˆç”»é¢ |
| metadata | object | âœ• | è¿½åŠ æƒ…å ± |

**æˆ»ã‚Šå€¤:**

```typescript
{
  success: boolean,
  notificationId?: string,
  error?: string
}
```

**ä¾‹:**

```javascript
const result = await sendNotification({
  type: 'info',
  message: 'ãƒ†ã‚¹ãƒˆé€šçŸ¥',
  recipientRoles: 'staff',
  title: 'ãŠçŸ¥ã‚‰ã›',
  deepLink: '/item1',
  metadata: {
    source: 'test',
    timestamp: new Date().toISOString()
  }
});

if (result.success) {
  console.log('é€šçŸ¥é€ä¿¡æˆåŠŸ:', result.notificationId);
} else {
  console.error('é€šçŸ¥é€ä¿¡å¤±æ•—:', result.error);
}
```
